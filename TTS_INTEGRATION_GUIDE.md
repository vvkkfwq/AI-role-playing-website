# 文字转语音(TTS)功能集成指南

## 概述

AI角色扮演聊天应用现已集成了基于OpenAI TTS API的文字转语音功能，为3个AI角色配置了不同的声音特征，提供高质量的语音合成体验。

## 功能特性

### ✨ 核心功能

1. **角色声音差异化**
   - 🎭 哈利·波特：年轻活力的男性声音 (echo)
   - 🏛️ 苏格拉底：深沉成熟的男性声音 (onyx)
   - 🧠 爱因斯坦：温和友善的学者声音 (fable)

2. **音频质量优化**
   - 使用OpenAI TTS-1-HD高质量模型
   - 支持多种音频格式 (MP3, Opus, AAC, FLAC)
   - 可调节语速 (0.25x - 4.0x)
   - 自然度和情感表达优化

3. **播放功能**
   - 流式音频播放
   - 播放控制 (重播功能)
   - 音频信息显示
   - 缓存状态指示

4. **性能优化**
   - 智能缓存机制 (7天有效期)
   - 异步音频生成
   - 生成进度提示
   - 自动重试机制

## 使用方法

### 🎙️ 启用TTS功能

1. **在侧边栏设置中**：
   - 开启"启用语音合成"开关
   - 可选择开启"自动播放"
   - 在高级设置中调整模型和格式

2. **在聊天界面中**：
   - AI回复后会显示"🎵 生成语音"按钮
   - 点击按钮生成角色语音
   - 生成后显示音频播放器

### 🎵 语音预览

在侧边栏中点击"🎵 试听角色声音"按钮，可以预览当前角色的声音特征。

### 💾 缓存管理

- 自动缓存生成的语音文件
- 支持手动清空缓存
- 自动清理过期文件
- 显示缓存使用统计

## 技术实现

### 🏗️ 架构设计

```
TTS服务架构:
├── tts_service.py          # 核心TTS服务
│   ├── TTSService         # OpenAI API集成
│   └── TTSManager         # 高级管理功能
├── audio_utils.py         # 音频工具扩展
│   └── TTSPlaybackUI      # TTS UI组件
├── models.py              # VoiceConfig模型
├── preset_characters.py   # 角色语音配置
└── app.py                 # 主应用集成
```

### 📝 代码示例

#### 基本TTS生成
```python
from tts_service import tts_manager

# 生成角色语音
tts_result = tts_manager.generate_character_speech(
    text="你好，我是哈利波特。",
    character=character,
    use_cache=True
)
```

#### 语音配置
```python
from models import VoiceConfig

voice_config = VoiceConfig(
    provider="openai",
    voice_id="echo",
    speed=1.1,
    volume=0.9
)
```

### 🔧 配置选项

#### TTS模型选择
- `tts-1-hd`: 高质量模型，生成速度较慢
- `tts-1`: 快速模型，质量标准

#### 音频格式
- `mp3`: 通用格式，兼容性好
- `opus`: 高压缩比，文件小
- `aac`: 高质量压缩
- `flac`: 无损音频

#### 缓存设置
- 默认缓存时长：7天
- 最大缓存大小：100MB
- 自动清理策略：LRU (最近最少使用)

## 角色声音特征

### 🎭 哈利·波特 (Echo)
- **特点**：年轻活力的男性声音
- **语速**：1.1x (稍快)
- **适用场景**：表现年轻、勇敢、充满活力的性格

### 🏛️ 苏格拉底 (Onyx)
- **特点**：深沉成熟的男性声音
- **语速**：0.9x (较慢)
- **适用场景**：体现智慧、深度思考、哲学思辨

### 🧠 爱因斯坦 (Fable)
- **特点**：温和友善的声音
- **语速**：1.0x (标准)
- **适用场景**：展现学者气质、温和平静的性格

## 性能优化

### 📈 缓存策略
- 基于文本内容和声音配置生成缓存键
- 自动检测缓存有效性
- 智能缓存大小管理
- 过期文件自动清理

### ⚡ 生成优化
- 异步音频生成
- 失败自动重试 (最多3次)
- 进度提示显示
- 错误处理机制

### 🎯 用户体验
- 生成状态实时显示
- 缓存命中状态提示
- 音频信息详细展示
- 一键重播功能

## 测试验证

### 🧪 自动化测试
运行完整的TTS功能测试：
```bash
python test_tts.py
```

测试涵盖：
- ✅ 模块导入
- ✅ 服务初始化
- ✅ 角色语音配置
- ✅ TTS生成功能
- ✅ 缓存机制
- ✅ UI组件
- ✅ 语音预览

### 📊 测试结果
所有7项测试均通过，TTS功能已经准备就绪。

## 部署要求

### 🔑 环境变量
确保设置以下环境变量：
```bash
OPENAI_API_KEY=your_api_key_here
```

### 📦 依赖包
已自动添加到requirements.txt：
```
streamlit>=1.29.0
openai>=1.3.0
pydub>=0.25.1
requests>=2.31.0
```

### 🏃 运行应用
```bash
# 安装依赖
pip install -r requirements.txt

# 启动应用
python run.py
# 或
streamlit run app.py
```

## 故障排除

### ❌ 常见问题

1. **API密钥错误**
   - 检查.env文件中的OPENAI_API_KEY
   - 确保API密钥有效且有足够额度

2. **音频生成失败**
   - 检查网络连接
   - 查看错误日志
   - 尝试切换TTS模型

3. **缓存问题**
   - 清空TTS缓存
   - 检查磁盘空间
   - 重启应用

### 🔧 调试技巧

1. **启用详细日志**：
   - 在测试脚本中查看详细输出
   - 检查缓存目录状态

2. **手动测试**：
   - 使用test_tts.py进行单独测试
   - 检查每个角色的语音生成

3. **性能监控**：
   - 监控缓存使用情况
   - 查看API调用频率

## 未来扩展

### 🚀 计划功能
- 更多声音选项
- 情感语调控制
- 语音速度实时调节
- 批量语音生成
- 语音质量评估

### 🎨 界面改进
- 可视化音频波形
- 播放进度条
- 音量控制滑块
- 声音均衡器

---

**注意**：TTS功能需要OpenAI API密钥，会产生相应的API调用费用。建议合理使用缓存功能以优化成本。